<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>宿題ヘルパーAI - コンプリート版</title>
    
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      body {
        font-family: 'Zen Maru Gothic', sans-serif;
        background-color: #f8fafc;
      }
      .animate-shake {
        animation: shake 0.3s ease-in-out infinite;
        animation-iteration-count: 2;
      }
      @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        75% { transform: translateX(5px); }
      }
      .shimmer {
        background: linear-gradient(90deg, #eff6ff 0%, #dbeafe 50%, #eff6ff 100%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
      }
      @keyframes shimmer {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useRef } = React;

      // --- 1. CONFIGURATION ---
      // ⚠ 注意: 本番公開時はAPIキーを空にして、ユーザーに入力させるUIを作ることをお勧めします
      const API_KEY = "AIzaSyDwQ_C3QufoHt8WvVOPPYRNP-o1NPfvZYM"; 
      const APP_PASSCODE = "2024";

      // --- 2. GEMINI API SERVICE ---
      async function callGemini(imagesBase64, settings, customInstruction) {
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${API_KEY}`;
        
        let promptText = `あなたは${settings.subject}を教える${settings.level}向けの優秀な教師です。
性格: ${settings.tone}。
指示: 送られた宿題の画像を解析し、ステップバイステップで解説してください。
数式はLaTeXを使用し、$ または $$ で囲んでください。
Markdown形式で出力してください。`;

        if (customInstruction) {
          promptText += `\n追加の指示: ${customInstruction}`;
        }

        const contents = [{
          parts: [
            { text: promptText },
            ...imagesBase64.map(base64 => ({
              inline_data: {
                mime_type: "image/jpeg",
                data: base64.split(',')[1]
              }
            }))
          ]
        }];

        const response = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ contents })
        });

        if (!response.ok) throw new Error('APIリクエストに失敗しました');
        const data = await response.json();
        return data.candidates[0].content.parts[0].text;
      }

      // --- 3. COMPONENTS ---

      // --- Settings Section ---
      const SettingsPanel = ({ settings, setSettings, disabled }) => (
        <div className="bg-white rounded-2xl p-6 shadow-sm border border-slate-200 grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label className="block text-xs font-bold text-slate-500 mb-1">教科</label>
            <select 
              value={settings.subject}
              onChange={e => setSettings({...settings, subject: e.target.value})}
              disabled={disabled}
              className="w-full bg-slate-50 border border-slate-200 rounded-lg p-2 focus:ring-2 focus:ring-indigo-500 outline-none"
            >
              <option>数学</option><option>理科</option><option>歴史/社会</option><option>英語</option><option>国語</option><option>プログラミング</option>
            </select>
          </div>
          <div>
            <label className="block text-xs font-bold text-slate-500 mb-1">レベル</label>
            <select 
              value={settings.level}
              onChange={e => setSettings({...settings, level: e.target.value})}
              disabled={disabled}
              className="w-full bg-slate-50 border border-slate-200 rounded-lg p-2 focus:ring-2 focus:ring-indigo-500 outline-none"
            >
              <option>小学生</option><option>中学生</option><option>高校生</option><option>大学生/専門</option>
            </select>
          </div>
          <div className="md:col-span-2">
            <label className="block text-xs font-bold text-slate-500 mb-1">教え方スタイル</label>
            <div className="flex gap-2">
              {['優しく丁寧に', '簡潔に答えのみ', 'ヒントで考えさせる'].map(t => (
                <button 
                  key={t}
                  onClick={() => setSettings({...settings, tone: t})}
                  disabled={disabled}
                  className={`flex-1 py-2 px-1 text-xs rounded-lg border transition-all ${settings.tone === t ? 'bg-indigo-600 border-indigo-600 text-white shadow-md' : 'bg-white border-slate-200 text-slate-600 hover:bg-slate-50'}`}
                >
                  {t}
                </button>
              ))}
            </div>
          </div>
        </div>
      );

      // --- 4. MAIN APPLICATION ---
      function App() {
        const [isAuth, setIsAuth] = useState(localStorage.getItem('hw_auth') === 'true');
        const [pass, setPass] = useState('');
        const [error, setError] = useState(false);
        
        const [images, setImages] = useState([]);
        const [settings, setSettings] = useState({ subject: '数学', level: '中学生', tone: '優しく丁寧に' });
        const [loading, setLoading] = useState(false);
        const [result, setResult] = useState('');
        const [memo, setMemo] = useState('');

        const handleAuth = (e) => {
          e.preventDefault();
          if (pass === APP_PASSCODE) {
            localStorage.setItem('hw_auth', 'true');
            setIsAuth(true);
          } else {
            setError(true);
            setTimeout(() => setError(false), 500);
          }
        };

        const onFileChange = (e) => {
          const files = Array.from(e.target.files);
          files.forEach(file => {
            const reader = new FileReader();
            reader.onloadend = () => setImages(prev => [...prev, reader.result]);
            reader.readAsDataURL(file);
          });
        };

        const handleSolve = async () => {
          setLoading(true);
          try {
            const text = await callGemini(images, settings, memo);
            setResult(text);
          } catch (err) {
            alert("エラーが発生しました。APIキーを確認してください。");
          } finally {
            setLoading(false);
          }
        };

        if (!isAuth) {
          return (
            <div className="min-h-screen flex items-center justify-center p-6 bg-slate-100">
              <form onSubmit={handleAuth} className={`bg-white p-8 rounded-3xl shadow-xl max-w-sm w-full transition-transform ${error ? 'animate-shake' : ''}`}>
                <h1 className="text-xl font-bold text-center mb-6">合言葉を入力</h1>
                <input 
                  type="password" 
                  value={pass} 
                  onChange={e => setPass(e.target.value)}
                  className="w-full border-2 border-slate-100 bg-slate-50 rounded-xl px-4 py-3 text-center text-xl tracking-widest focus:border-indigo-500 outline-none mb-4"
                  placeholder="****"
                />
                <button className="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-indigo-700">解除する</button>
                <p className="text-center text-xs text-slate-400 mt-4">Default: 2024</p>
              </form>
            </div>
          );
        }

        return (
          <div className="max-w-2xl mx-auto px-4 py-10">
            <header className="text-center mb-10">
              <div className="inline-block bg-indigo-600 p-3 rounded-2xl shadow-indigo-200 shadow-lg mb-4">
                <svg className="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>
              </div>
              <h1 className="text-3xl font-extrabold text-slate-800">宿題ヘルパーAI</h1>
            </header>

            {!result ? (
              <div className="space-y-6">
                <SettingsPanel settings={settings} setSettings={setSettings} disabled={loading} />

                <div className="bg-white border-2 border-dashed border-slate-200 rounded-3xl p-8 text-center hover:border-indigo-400 transition-colors">
                  {images.length > 0 ? (
                    <div className="grid grid-cols-3 gap-2">
                      {images.map((img, i) => (
                        <div key={i} className="relative group">
                          <img src={img} className="h-24 w-full object-cover rounded-lg" />
                          <button onClick={() => setImages(images.filter((_, idx) => idx !== i))} className="absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 opacity-0 group-hover:opacity-100">×</button>
                        </div>
                      ))}
                      <label className="h-24 border-2 border-slate-100 flex items-center justify-center rounded-lg cursor-pointer hover:bg-slate-50">
                        <span className="text-2xl text-slate-300">+</span>
                        <input type="file" className="hidden" onChange={onFileChange} multiple accept="image/*" />
                      </label>
                    </div>
                  ) : (
                    <label className="cursor-pointer block">
                      <div className="text-slate-400 mb-2">宿題の写真をアップロード</div>
                      <div className="text-xs text-slate-300">タップしてカメラを起動</div>
                      <input type="file" className="hidden" onChange={onFileChange} multiple accept="image/*" />
                    </label>
                  )}
                </div>

                <textarea 
                  placeholder="追加の指示があれば入力（例：問3だけ教えて）"
                  className="w-full bg-white border border-slate-200 rounded-2xl p-4 h-24 focus:ring-2 focus:ring-indigo-500 outline-none"
                  value={memo}
                  onChange={e => setMemo(e.target.value)}
                />

                <button 
                  onClick={handleSolve}
                  disabled={loading || images.length === 0}
                  className="w-full bg-gradient-to-r from-indigo-600 to-blue-600 text-white py-4 rounded-2xl font-bold shadow-xl disabled:opacity-50 transition-transform active:scale-95"
                >
                  {loading ? 'AIが考え中...' : 'AI先生に聞く'}
                </button>
              </div>
            ) : (
              <div className="space-y-6 animate-fade-in">
                <div className="bg-white rounded-3xl p-6 shadow-sm border border-slate-100 prose prose-slate max-w-none">
                  <div className="whitespace-pre-wrap text-slate-700 leading-relaxed">
                    {result}
                  </div>
                </div>
                <button 
                  onClick={() => { setResult(''); setImages([]); }}
                  className="w-full bg-slate-800 text-white py-4 rounded-2xl font-bold"
                >
                  次の問題を解く
                </button>
              </div>
            )}
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
